<!doctype html>
<meta charset="utf-8">
<title>WS Handshake Auth Test</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

<div class="container" style="margin-top:20px">
    <div class="form-inline">
        <input id="token" class="form-control" style="width:420px" placeholder="JWT access token">
        <input id="roomId" class="form-control" style="width:160px" placeholder="roomId (예: 1)">
        <button id="connect" class="btn btn-primary">Connect</button>
        <button id="disconnect" class="btn btn-default" disabled>Disconnect</button>
    </div>
    <hr>
    <div class="form-inline">
        <input id="msg" class="form-control" style="width:480px" placeholder="메시지">
        <button id="send" class="btn btn-success">Send</button>
    </div>
    <hr>
    <pre id="log" style="white-space:pre-wrap"></pre>
</div>

<script>
    let client;
    const log = (m)=>document.querySelector('#log').textContent += m + "\n";

    document.querySelector('#connect').onclick = () => {
        const token  = document.querySelector('#token').value.trim();
        const roomId = document.querySelector('#roomId').value.trim() || '1';

        // ★ 토큰을 쿼리로 붙여 핸드셰이크
        const url = 'https://draids.site/ws/chat?access_token=' + encodeURIComponent(token);

        const sock = new SockJS(url);
        client = Stomp.over(sock);
        client.debug = (str) => log(str);

        // STOMP CONNECT 시 Authorization 헤더는 필요 없음(Principal은 핸드셰이크에서 이미 고정)
        client.connect({}, () => {
            log('[CONNECTED]');
            document.querySelector('#disconnect').disabled = false;

            client.subscribe('/topic/messages/' + roomId, msg => {
                try {
                    const body = JSON.parse(msg.body);
                    log('[RECV] ' + (body.role || 'ai') + ': ' + body.message);
                } catch(e) {
                    log('[RECV RAW] ' + msg.body);
                }
            });
        }, err => log('[ERROR] ' + err));
    };

    document.querySelector('#disconnect').onclick = () => {
        if (client) client.disconnect(()=>log('[DISCONNECTED]'));
        document.querySelector('#disconnect').disabled = true;
    };

    document.querySelector('#send').onclick = () => {
        if (!client || !client.connected) return log('[WARN] Not connected');
        const roomId = document.querySelector('#roomId').value.trim() || '1';
        const text   = document.querySelector('#msg').value || 'ping';

        client.send('/app/send',
            { 'content-type':'application/json' },
            JSON.stringify({ roomId, message: text })
        );
        log('[SEND] me: ' + text);
    };
</script>

